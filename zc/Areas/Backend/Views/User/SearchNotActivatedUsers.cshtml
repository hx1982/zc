
@{
    ViewBag.Title = "未激活用户";
}


<style>
    #tb span, .combobox-item {
        font-size: 16px;
    }

    #tb .query-input {
        line-height: 26px;
        border: 1px solid #ccc;
    }

    #tb input {
        font-size: 15px;
    }

    .tbspan {
        padding-left: 20px;
    }

    .input-width {
        width: 16%;
    }

    .datagrid-header .datagrid-cell span {
        font-size: 15px !important;
    }

    .fitem {
        margin-bottom: 15px;
    }

        .fitem label {
            display: inline-block;
            width: 6em;
            text-align: right;
        }

    .easyui-textbox, .easyui-combobox {
        width: 180px;
    }
</style>

<div id="tb" style="padding:2%">
    <form id="tbForm">
        <span class="tbspan">会员名称：</span>
        <input id="userName" name="userName" class="input-width query-input">

        <span class="tbspan">手机号码：</span>
        <input id="userPhone" name="userPhone" class="input-width query-input ">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitForm()" iconCls="icon-search" style="width: 80px;margin-left: 20px;">查询</a>
    </form>
</div>
<table id="tt" class="easyui-datagrid" style="width:100%;height:100%"
       toolbar="#tb" rownumbers="true" pagination="true" data-options="url:'@Url.Action("SearchNotActivatedUsers","User")',fitColumns:true,singleSelect:true">
    <thead>
        <tr>
            <th field="user_code">会员编号</th>
            <th field="user_name">会员名称</th>
            <th field="user_phone">手机号码</th>
            <th field="id_number">身份证号</th>
            <th field="province">省</th>
            <th field="city">市</th>
            <th field="area">区</th>
            <th field="address">详细地址</th>
            <th field="reg_money">注册金额</th>
            <th field="referrer_id">推荐人</th>
            <th field="user_id" formatter="generateOperations">操作</th>
        </tr>
    </thead>
</table>

<div id="dlg" class="easyui-dialog" style="width:600px;height:auto;padding:10px 20px"
     closed="true" buttons="#dlg-buttons">
    <form id="fm" method="post">
        <input type="hidden" name="user_id" />
        <div class="fitem">
            <label>会员编号</label>
            <input name="user_code" class="easyui-textbox">
            <label>会员名称</label>
            <input name="user_name" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>手机号</label>
            <input name="user_phone" class="easyui-textbox">
            <label>身份证号</label>
            <input name="id_number" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>推荐人</label>
            <input name="referrer_id" class="easyui-textbox">
        </div>
        <hr />
        <div class="fitem">
            <label>注册金额</label>
            <select name="reg_money" class="easyui-combobox" style="width: 180px">
                <option value="18000">18000元</option>
                <option value="32000">32000元</option>
                <option value="76000">76000元</option>
            </select>
            <label>省</label>
            <input name="province" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>市</label>
            <input name="city" class="easyui-textbox">
            <label>区</label>
            <input name="area" class="easyui-textbox">
        </div>
        <div class="fitem">
            <label>详细地址</label>
            <input name="address" class="easyui-textbox" multiline="true" style="width: 450px">
        </div>
    </form>
</div>
<div id="dlg-buttons">
    <a href="#" class="easyui-linkbutton" iconCls="icon-ok" onclick="activeUser()">激活</a>
    <a href="#" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')">取消</a>
</div>

<script>
    // 将form data序列化为json object
    $.fn.serializeObject = function () {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
            if (o[this.name]) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    }

    function submitForm() {
        $('#tt').datagrid('load', {
            "userName": $('#userName').val(),
            "userPhone": $('#userPhone').val()
        });
    }

    function generateOperations(val, row, index) {
        if(row.user_status == 2)
            return '<button data-rowindex="' + index + '" class="easyui-linkbutton" onclick="optionActiveForm('+index+')">激活</button>';
        return '已激活';
    }

    var i = 0;
    function optionActiveForm(index) {
        i = index;
        $('#tt').datagrid('selectRow', index);
        var row = $('#tt').datagrid('getRows')[index];
        $('#dlg').dialog('open').dialog('setTitle', '激活会员');
        $('#fm').form('load', row);
    }

    function activeUser() {
        $('#fm').form('submit', {
            url: '@Url.Action("ActiveUser", "User")',
            onSubmit: function () {
                var regMoney = document.forms['fm'].reg_money.value;
                if (regMoney != 18000 && regMoney != 32000 && regMoney != 76000) {
                    alert('注册金额必须是1.8万/3.2万/7.6万');
                    return false;
                }
                return true;
            },
            success: function (data) {
                data = eval('(' + data + ')');
                console.log(data);
                if (data.code == 200) {
                    $('#tt').datagrid('updateRow', {
                        index: i,
                        row: data.data
                    });
                    $.messager.alert('系统提示', '激活成功');
                    $('#dlg').dialog('close');
                }
            }
        });
    }
</script>